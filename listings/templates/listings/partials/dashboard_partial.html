<!-- templates/listings/partials/dashboard_partial.html -->

<!-- Header -->
<div class="card mb-3 shadow-sm">
  <div class="card-body d-flex align-items-center justify-content-between">
    <div>
      <div class="text-muted small">لوحة التحكم</div>
      <h3 class="mb-0">نظام إدارة العقارات والمستأجرين</h3>
      <div class="text-muted small mt-1">ملخص سريع وأهم التنبيهات</div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary btn-sm"
         href="{% url 'tenant_list' %}"
         hx-get="{% url 'tenant_list' %}" hx-target="#main-content" hx-push-url="true">
        المستأجرون
      </a>

      <a class="btn btn-primary btn-sm"
         href="{% url 'lease_list' %}"
         hx-get="{% url 'lease_list' %}" hx-target="#main-content" hx-push-url="true">
        العقود
      </a>
    </div>
  </div>
</div>

<!-- KPI Cards -->
<div class="row g-3">

  <div class="col-12 col-md-6 col-xl-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">عدد المباني</div>
        <div class="fs-2 fw-bold">{{ stats.buildings }}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 col-xl-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">عدد الشقق</div>
        <div class="fs-2 fw-bold">{{ stats.apartments }}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 col-xl-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">الشقق الفارغة</div>
        <div class="fs-2 fw-bold">{{ stats.vacant }}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 col-xl-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">عقود الإيجار (نشطة)</div>
        <div class="fs-2 fw-bold">{{ stats.active_leases }}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 col-xl-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">عدد المستأجرين</div>
        <div class="fs-2 fw-bold">{{ stats.tenants }}</div>
      </div>
    </div>
  </div>

  <!-- Occupancy -->
  <div class="col-12 col-xl-5">
    <div class="card h-100 shadow-sm">
      <div class="card-body">

        {% with occ=0 %}
          {% if stats.apartments %}
            {% widthratio stats.rented stats.apartments 100 as occ %}
          {% endif %}

          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="text-muted small">نسبة الإشغال</div>
              <div class="fw-bold">
                {{ stats.rented }} مؤجرة /
                {{ stats.apartments }} إجمالي
              </div>
            </div>

            <div class="text-end">
              <div class="text-muted small">النسبة</div>
              <div class="fs-4 fw-bold">{{ occ }}%</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="progress occ-progress">
              <div class="progress-bar occ-bar"
                   role="progressbar"
                   data-width="{{ occ|default:0 }}"
                   aria-valuenow="{{ occ|default:0 }}"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>

            <div class="d-flex justify-content-between mt-2 small text-muted">
              <span>شاغرة: <span class="fw-semibold">{{ stats.vacant }}</span></span>
              <span>مؤجرة: <span class="fw-semibold">{{ stats.rented }}</span></span>
            </div>
          </div>

        {% endwith %}

      </div>
    </div>
  </div>

  <div class="col-12 col-xl-4">
    <div class="card h-100 border-warning shadow-sm">
      <div class="card-body">
        <div class="text-muted small">تنتهي خلال {{ soon_days }} يوم</div>
        <div class="fs-2 fw-bold">{{ stats.expiring_soon }}</div>
      </div>
    </div>
  </div>

</div>

<hr class="my-4">

<!-- Expiring leases -->
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">عقود قاربت على الانتهاء</h5>

    {% if expiring_leases %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>المستأجر</th>
              <th>العمارة</th>
              <th>الشقة</th>
              <th>تاريخ الانتهاء</th>
              <th class="text-end">متبقي</th>
            </tr>
          </thead>
          <tbody>
            {% for l in expiring_leases %}
              <tr>
                <td>{{ l.tenant.full_name }}</td>
                <td>{{ l.apartment.building.name }}</td>
                <td>{{ l.apartment.apartment_no }}</td>
                <td>{{ l.end_date }}</td>
                <td class="text-end">{{ l.end_date|timeuntil }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">لا يوجد عقود ستنتهي قريبًا.</div>
    {% endif %}
  </div>
</div>
